name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 2 * * *"   # Nightly at 02:00 UTC

jobs:

  # ─────────────────────────────────────────────────────────────
  # Stage 1 — Fast checks on every push / PR
  # Runs: linting, SAST, unit tests, coverage gate
  # ─────────────────────────────────────────────────────────────
  fast-checks:
    name: "Fast checks (lint · SAST · unit tests)"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Lint — flake8
        run: |
          pip install flake8
          flake8 mocks/ tests/ --max-line-length=100 --extend-ignore=E203

      - name: Format check — black
        run: |
          pip install black
          black --check mocks/ tests/ --line-length=100

      - name: SAST — Bandit
        run: bandit -r mocks/ -f json -o bandit-report.json -ll
        continue-on-error: true   # report findings; do not block on low severity

      - name: Unit tests with coverage
        run: |
          pytest -m unit \
            --cov=mocks \
            --cov-report=xml \
            --cov-report=term-missing \
            --cov-fail-under=80 \
            --html=unit-test-report.html \
            --self-contained-html \
            -v

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: coverage.xml
        continue-on-error: true

      - name: Upload unit test report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-report
          path: |
            unit-test-report.html
            test-results.xml
            test.log

      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: bandit-report.json

  # ─────────────────────────────────────────────────────────────
  # Stage 2 — Integration + security tests on PR approval
  # ─────────────────────────────────────────────────────────────
  integration-tests:
    name: "Integration & security tests"
    runs-on: ubuntu-latest
    needs: fast-checks

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Integration tests
        run: pytest -m integration -v

      - name: Security tests
        run: pytest -m security -v

      - name: Generate HTML report
        if: always()
        run: |
          pytest -m "integration or security" \
            --html=test-report.html \
            --self-contained-html \
            -v || true

      - name: Upload test report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-security-report
          path: |
            test-report.html
            test-results.xml
            test.log

  # ─────────────────────────────────────────────────────────────
  # Stage 3 — Load tests (nightly schedule only)
  # Runs pytest pipeline throughput suite; fails if SLA thresholds are breached
  # ─────────────────────────────────────────────────────────────
  load-tests:
    name: "Load tests (nightly)"
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run pipeline load tests
        run: |
          pytest tests/load/test_pipeline_throughput.py \
            --html=load-test-report.html \
            --self-contained-html \
            -v

      - name: Upload load test report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: load-test-report
          path: |
            load-test-report.html
            test-results.xml
            test.log

      - name: Notify Slack on SLA breach
        if: failure()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": ":warning: *Load test SLA breach* on `${{ github.repository }}`\nRun: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
