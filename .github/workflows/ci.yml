name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 2 * * *"   # Nightly at 02:00 UTC

jobs:

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Stage 1 â€” Fast checks on every push / PR
  # Runs: linting, SAST, unit tests, coverage gate
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  fast-checks:
    name: "Fast checks (lint Â· SAST Â· unit tests)"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Lint â€” flake8
        run: flake8 mocks/ tests/ --max-line-length=100 --extend-ignore=E203

      - name: Format check â€” black
        run: black --check mocks/ tests/ --line-length=100

      - name: SAST â€” Bandit
        run: |
          bandit -r mocks/ -f json -o bandit-report.json -ll || true
          bandit -r mocks/ -ll 2>&1 | tee bandit_output.txt || true
          echo "## ðŸ”’ SAST Scan (Bandit)" >> $GITHUB_STEP_SUMMARY
          if grep -q "No issues identified" bandit_output.txt; then
            echo "âœ… No security issues identified." >> $GITHUB_STEP_SUMMARY
          else
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat bandit_output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

      - name: Unit tests with coverage
        run: |
          pytest -m unit \
            --cov=mocks \
            --cov-report=xml \
            --cov-report=term-missing \
            --cov-fail-under=80 \
            --html=unit-test-report.html \
            --self-contained-html \
            -v 2>&1 | tee pytest_unit_output.txt
          echo "## ðŸ§ª Unit Test Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -30 pytest_unit_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Coverage summary
        if: always()
        run: |
          echo "## ðŸ“Š Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          pytest -m unit --cov=mocks --cov-report=term-missing -q 2>&1 | grep -E "^(mocks|TOTAL|Coverage)" | head -20 >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: coverage.xml
        continue-on-error: true

      - name: Upload unit test report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-report
          path: |
            unit-test-report.html
            test-results.xml
            test.log

      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-report
          path: bandit-report.json

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Stage 2 â€” Integration + contract + chaos + security tests
  # Runs after fast-checks pass
  # All these tests use the in-memory broker â€” NO Docker needed
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  integration-tests:
    name: "Integration Â· Contract Â· Chaos Â· Security tests"
    runs-on: ubuntu-latest
    needs: fast-checks

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Integration tests (in-memory pipeline)
        run: |
          pytest -m integration -v \
            --html=integration-report.html \
            --self-contained-html \
            2>&1 | tee integration_output.txt
          echo "## ðŸ”— Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -20 integration_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Contract tests (schema compatibility between components)
        run: |
          pytest tests/contract/ -v \
            --html=contract-report.html \
            --self-contained-html \
            2>&1 | tee contract_output.txt
          echo "## ðŸ“‹ Contract Test Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -20 contract_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Chaos / resilience tests (failure-mode scenarios)
        run: |
          pytest tests/chaos/ -v \
            --html=chaos-report.html \
            --self-contained-html \
            2>&1 | tee chaos_output.txt
          echo "## ðŸ’¥ Chaos & Resilience Test Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -20 chaos_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Security tests (auth Â· injection Â· rate limiting)
        run: |
          pytest -m security -v \
            --html=security-report.html \
            --self-contained-html \
            2>&1 | tee security_output.txt
          echo "## ðŸ›¡ï¸ Security Test Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -20 security_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload all test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-security-reports
          path: |
            integration-report.html
            contract-report.html
            chaos-report.html
            security-report.html
            test-results.xml
            test.log

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Stage 2b â€” Real-service integration tests (optional)
  # Runs only when Docker services are available in CI
  # Uses GitHub Actions service containers for RabbitMQ + PostgreSQL
  # Tests auto-skip gracefully if services are unreachable
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  real-service-tests:
    name: "Real-service tests (RabbitMQ + PostgreSQL)"
    runs-on: ubuntu-latest
    needs: fast-checks

    services:
      rabbitmq:
        image: rabbitmq:3.12-management
        ports:
          - 5672:5672
        env:
          RABBITMQ_DEFAULT_USER: guest
          RABBITMQ_DEFAULT_PASS: guest
        options: >-
          --health-cmd "rabbitmq-diagnostics ping"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 10

      postgres:
        image: postgres:15
        ports:
          - 5432:5432
        env:
          POSTGRES_DB: features_db
          POSTGRES_USER: qa_user
          POSTGRES_PASSWORD: qa_password
        options: >-
          --health-cmd "pg_isready -U qa_user -d features_db"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 10

    env:
      RABBITMQ_HOST: localhost
      RABBITMQ_PORT: 5672
      RABBITMQ_USER: guest
      RABBITMQ_PASSWORD: guest
      POSTGRES_HOST: localhost
      POSTGRES_PORT: 5432
      POSTGRES_DB: features_db
      POSTGRES_USER: qa_user
      POSTGRES_PASSWORD: qa_password

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Real-service integration tests
        run: |
          pytest tests/integration_real/ -v \
            --html=real-service-report.html \
            --self-contained-html \
            2>&1 | tee real_output.txt
          echo "## ðŸ³ Real-Service Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -20 real_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload real-service report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: real-service-report
          path: |
            real-service-report.html
            test-results.xml
            test.log

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Stage 3 â€” Load tests (nightly schedule only)
  # Uses pytest pipeline throughput suite (NOT Locust â€” no server needed)
  # Fails the job if SLA thresholds are breached
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  load-tests:
    name: "Load tests (nightly)"
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run pipeline load tests (SLA-gated)
        run: |
          pytest tests/load/ \
            --html=load-test-report.html \
            --self-contained-html \
            -v -s \
            2>&1 | tee load_output.txt
          echo "## âš¡ Load Test Results (Nightly SLA Check)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -30 load_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          if grep -q "FAILED" load_output.txt; then
            echo "## âŒ SLA BREACH DETECTED" >> $GITHUB_STEP_SUMMARY
            echo "One or more load test SLA thresholds were breached. Check the full report artifact." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… All SLA thresholds passed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload load test report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: load-test-report
          path: |
            load-test-report.html
            test-results.xml
            test.log

      - name: Notify Slack on SLA breach
        if: failure()
        uses: slackapi/slack-github-action@v1
        continue-on-error: true   # do not fail the job if Slack secret is missing
        with:
          payload: |
            {
              "text": ":warning: *Load test SLA breach* on `${{ github.repository }}`\nRun: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
