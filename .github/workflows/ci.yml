name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 2 * * *"   # Nightly at 02:00 UTC

jobs:

  # ─────────────────────────────────────────────────────────────
  # Stage 1 — Fast checks on every push / PR
  # Runs: linting, SAST, unit tests, coverage gate
  # ─────────────────────────────────────────────────────────────
  fast-checks:
    name: "Fast checks (lint · SAST · unit tests)"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Lint — flake8
        run: flake8 mocks/ tests/ --max-line-length=100 --extend-ignore=E203

      - name: Format check — black
        run: black --check mocks/ tests/ --line-length=100

      - name: SAST — Bandit
        run: bandit -r mocks/ -f json -o bandit-report.json -ll
        continue-on-error: true

      - name: Unit tests with coverage
        run: |
          pytest -m unit \
            --cov=mocks \
            --cov-report=xml \
            --cov-report=term-missing \
            --cov-fail-under=80 \
            --html=unit-test-report.html \
            --self-contained-html \
            -v

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: coverage.xml
        continue-on-error: true

      - name: Upload unit test report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-report
          path: |
            unit-test-report.html
            test-results.xml
            test.log

      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-report
          path: bandit-report.json

  # ─────────────────────────────────────────────────────────────
  # Stage 2 — Integration + contract + chaos + security tests
  # Runs after fast-checks pass
  # All these tests use the in-memory broker — NO Docker needed
  # ─────────────────────────────────────────────────────────────
  integration-tests:
    name: "Integration · Contract · Chaos · Security tests"
    runs-on: ubuntu-latest
    needs: fast-checks

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Integration tests (in-memory pipeline)
        run: pytest -m integration -v --html=integration-report.html --self-contained-html

      - name: Contract tests (schema compatibility between components)
        run: pytest tests/contract/ -v --html=contract-report.html --self-contained-html
        continue-on-error: false

      - name: Chaos / resilience tests (failure-mode scenarios)
        run: pytest tests/chaos/ -v --html=chaos-report.html --self-contained-html
        continue-on-error: false

      - name: Security tests (auth · injection · rate limiting)
        run: pytest -m security -v --html=security-report.html --self-contained-html

      - name: Upload all test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-security-reports
          path: |
            integration-report.html
            contract-report.html
            chaos-report.html
            security-report.html
            test-results.xml
            test.log

  # ─────────────────────────────────────────────────────────────
  # Stage 2b — Real-service integration tests (optional)
  # Runs only when Docker services are available in CI
  # Uses GitHub Actions service containers for RabbitMQ + PostgreSQL
  # Tests auto-skip gracefully if services are unreachable
  # ─────────────────────────────────────────────────────────────
  real-service-tests:
    name: "Real-service tests (RabbitMQ + PostgreSQL)"
    runs-on: ubuntu-latest
    needs: fast-checks

    services:
      rabbitmq:
        image: rabbitmq:3.12-management
        ports:
          - 5672:5672
        env:
          RABBITMQ_DEFAULT_USER: guest
          RABBITMQ_DEFAULT_PASS: guest
        options: >-
          --health-cmd "rabbitmq-diagnostics ping"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 10

      postgres:
        image: postgres:15
        ports:
          - 5432:5432
        env:
          POSTGRES_DB: features_db
          POSTGRES_USER: qa_user
          POSTGRES_PASSWORD: qa_password
        options: >-
          --health-cmd "pg_isready -U qa_user -d features_db"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 10

    env:
      RABBITMQ_HOST: localhost
      RABBITMQ_PORT: 5672
      RABBITMQ_USER: guest
      RABBITMQ_PASSWORD: guest
      POSTGRES_HOST: localhost
      POSTGRES_PORT: 5432
      POSTGRES_DB: features_db
      POSTGRES_USER: qa_user
      POSTGRES_PASSWORD: qa_password

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Real-service integration tests
        run: |
          pytest tests/integration_real/ -v \
            --html=real-service-report.html \
            --self-contained-html

      - name: Upload real-service report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: real-service-report
          path: |
            real-service-report.html
            test-results.xml
            test.log

  # ─────────────────────────────────────────────────────────────
  # Stage 3 — Load tests (nightly schedule only)
  # Uses pytest pipeline throughput suite (NOT Locust — no server needed)
  # Fails the job if SLA thresholds are breached
  # ─────────────────────────────────────────────────────────────
  load-tests:
    name: "Load tests (nightly)"
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run pipeline load tests (SLA-gated)
        run: |
          pytest tests/load/test_pipeline_throughput.py \
            --html=load-test-report.html \
            --self-contained-html \
            -v -s

      - name: Upload load test report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: load-test-report
          path: |
            load-test-report.html
            test-results.xml
            test.log

      - name: Notify Slack on SLA breach
        if: failure()
        uses: slackapi/slack-github-action@v1
        continue-on-error: true   # do not fail the job if Slack secret is missing
        with:
          payload: |
            {
              "text": ":warning: *Load test SLA breach* on `${{ github.repository }}`\nRun: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
